<!doctype html>
<html>
<head>
    <title>OMNE.AI</title>
    <link id="favicon" rel="icon" type="image/png" href="favicon-48x48.png">
    <!--<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">-->
    <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
    <link rel="stylesheet"
        href="https://use.fontawesome.com/releases/v5.4.1/css/all.css"
        integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz"
        crossorigin="anonymous">
    <!--<script>!function (e, t, a, n, g) {-->
    <!--e[n] = e[n] || [], e[n].push({ "gtm.start": (new Date).getTime(), event: "gtm.js" });-->
    <!--var m = t.getElementsByTagName(a)[0], r = t.createElement(a);-->
    <!--r.async = !0, r.src = "https://www.googletagmanager.com/gtm.js?id=GTM-KV7435L", m.parentNode.insertBefore(r, m)-->
    <!--}(window, document, "script", "dataLayer")</script>-->

    <script type="text/javascript" src="js/SendBird.min.js"></script>
    <script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "SoftwareApplication",
    "name": "OMNE: Effortless Investing",
    "publisher":
    {
    "@type": "Organization",
    "name": "OMNE"
    },
    "applicationCategory": "Business",
    "applicationSubCategory": "Business Software",
    "downloadUrl": "https://www.google.com",
    "installUrl": "https://www.apple.com",
    "operatingSystem": "Android, iOs"
    }





    </script>
    <script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "LocalBusiness",
    "name": "OMNE",
    "description": "Let your Bot invest while you enjoy lower fees.",
    "legalName": "OMNE",
    "image": "https://omne.ai/img/logo_black.svg",
    "founder": "Giovanni Piccinelli",
    "telephone": "+39 392 8750821",
    "email": "hi@omne.ai",
    "url": "https://www.omne.ai",
    "sameAs": ["http://www.facebook.com/omne", "http://www.linkedin.com/company/omne"],
    "openingHours": "Mo-Su, All day",
    "address":
    {
    "@type": "PostalAddress",
    "streetAddress": "Via Bartolomeo Eustachi, 12 - CAP 20129",
    "addressLocality": "Italy",
    "addressCountry": "Italy",
    "postalCode": "20129"
    }
    }






    </script>
    <style type="text/css">
        .js-plotly-plot .plotly .modebar {
            display: none;
        }

        .js-plotly-plot .plotly svg a {
            display: none;
        }

        .hidden {
            display: none !important;
        }

        body {
            width: 100%;
            height: 100vh;
            display: flex;
            background-color: rgb(247, 247, 247);
            -webkit-box-pack: justify;
            justify-content: space-between;
            -webkit-box-align: stretch;
            align-items: stretch;
        }

        .svg {
            width: 100%;
        }

        .main-svg {
            background: transparent !important;
        }

        #graphs-container {
            display: flex;
            flex: 2.5 3 300px;
            overflow: scroll;
            flex-direction: column;
            background: rgb(247, 247, 247);
        }

        .side-column {
            display: flex;
            flex: 1.5 1 100px;
            position: relative;
            overflow: scroll;
            flex-direction: column;
        }

        .chat-column {
            position: relative;
            display: flex;
            flex: 3 3 300px;
            overflow-y: scroll;
            overflow-x: hidden;
            flex-direction: column;
            background: white;
            height: 100%;
        }

        #avatar {
            border-radius: 50%;
            width: 80%;
            margin: 10px auto;
            cursor: pointer;
        }

        #user-id, #user-nickname {
            font-size: 12px;
            text-align: center;
            margin: 0;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        #user-id {
            border-bottom: 1px solid lightgray;
            padding-bottom: 10px;
        }

        #user-nickname {
            margin-top: 10px;
        }

        .user-data__container {
            margin: 10px;
            border: 1px solid lightgray;
            padding: 10px 0;
            border-radius: 9px;
            background: #fff;
        }

        .doc-content {
            display: none;
        }

        #control-buttons > button, #control-buttons > a {
            display: block;
            margin: 5px auto;
            width: 70%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .container {
            padding: 0;
        }

        html {
            max-height: 100%;
            /*overflow: hidden;*/
        }

        #docs {
            padding: 10px;
        }

        .file-container, .file-data {
            position: relative;
            display: flex;
            flex-direction: row;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 10px;
            border: 1px solid rgb(247, 247, 247);
        }

        .file-data {
            margin-right: 10px;
        }

        .file-data:hover {
            border: 1px solid grey;
            background: rgba(190, 190, 190, 0.5);
            cursor: pointer;
        }

        .file-preview {
            width: 10%;
            margin-right: 0.3em;
        }

        .file-preview img {
            width: 100%;
            height: 100%;
        }

        .file-description {
            align-self: center;
        }

        .file-description__filename {
            font-weight: bold;
            font-size: 0.7em;
        }

        .file-description__text {
            font-size: 0.9em;
            font-style: italic;
            color: gray;
        }

        .file-description__link {
            display: none;
        }

        #search-bar {
            margin-bottom: 10px;
            width: 37.5vw;
            z-index: 999;
        }

        .message-container {
            align-self: flex-end;
            margin: 0 0 20px 90px;
        }

        .message-container .my-message {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .message-container .my-message .message-text:first-child {
            border-radius: 8px 8px 0;
        }

        .message-container .my-message .message-text {
            color: rgb(255, 255, 255);
            font-weight: 300;
            letter-spacing: -0.2px;
            align-self: flex-end;
            display: grid;
            -webkit-box-align: stretch;
            align-items: stretch;
            max-width: 450px;
            word-break: break-word;
            background: rgb(77, 213, 157);
            border-radius: 8px 0px 0px 8px;
            overflow: hidden;
            grid-template: auto 100% none;
            gap: 10px 0px;
        }

        .message-container .my-message .message-text span {
            line-height: 20px;
            white-space: pre-wrap;
            margin: 0px 10px;
        }

        .message-container .my-message .message-text span:first-child {
            margin-top: 10px;
        }

        .message-container .my-message .message-text span:last-child {
            margin-bottom: 10px;
        }

        .message-container .sent-at {
            font-size: 12px;
            line-height: 22px;
            color: rgb(178, 178, 178);
            text-align: right;
            -webkit-font-smoothing: antialiased;
            letter-spacing: -0.2px;
        }

        /* RESPONDER */
        .responder-message-container {
            display: block;
            align-self: flex-start;
            grid-template: auto / 40px calc(100% - 45px);
            gap: 0px 5px;
            padding: 0px 50px 20px 0px;
        }

        .admin-message {
            display: block;
            margin: auto;
            text-align: center;
            width: 70%;
            padding-right: 0;
        }

        .admin-message > .sender {
            display: none;
        }

        .admin-message__android-icon {
            display: block;
            font-size: 3em;
        }

        .text--admin-message {
            width: 100% !important;
            border-radius: 8px !important;
            background: #ED4059 !important;
            color: white !important;
            padding: 15px 0 !important;
        }

        .responder-message-container img.user-avatar {
            float: left;
            top: 4px;
            width: 40px;
            height: 40px;

            border-radius: 50%;
            grid-row: 1 / span 3;
        }

        .responder-message-container .sender {
            font-size: 12px;
            line-height: 22px;
            color: rgb(178, 178, 178);
            -webkit-font-smoothing: antialiased;
            letter-spacing: -0.2px;
        }

        .responder-message-container .message-text-container {
            display: flex;
            flex-direction: column;
        }

        .responder-message-container .message-text-container .message-text {
            position: relative;
            width: 100%;
            display: grid;
            grid-auto-flow: column;
            grid-template: auto auto none;
            gap: 20px 20px;
        }

        .responder-message-container .message-text-container .message-text .text {
            width: 270px;
            max-width: 270px;
            transform: translate(0px, 0px);
            transition: transform 0.3s ease 0s;
            border-radius: 8px;
            font-weight: 300;
            letter-spacing: -0.2px;
            align-self: flex-start;
            display: grid;
            -webkit-box-align: stretch;
            align-items: stretch;
            max-width: 450px;
            word-break: break-word;
            background: rgb(248, 248, 248);
            /*border-radius: 0px 8px 8px 0px;*/
            overflow: hidden;
            grid-template: auto / 100% none;
            gap: 10px 0px;
        }

        .responder-message-container .message-text-container .message-text .text:last-child {
            border-radius: 0px 8px 8px;
        }

        .responder-message-container .message-text-container .message-text .text div {
            line-height: 20px;
            white-space: pre-wrap;
            margin: 0px 10px;
        }

        .responder-message-container .message-text-container .message-text .text div:last-child {
            margin-bottom: 10px;
        }

        .responder-message-container .message-text-container .message-text .text button:last-child {
            margin-bottom: 10px;
        }

        .responder-message-container .message-text-container .message-text .text div:first-child {
            margin-top: 10px;
        }

        #message-templates {
            display: none;
        }

        .portfolio-selector {
            display: inline-block !important;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            width: 68%;
            margin: 0 1.5%;
            font-size: 12px !important;
            background: transparent;
        }

        .portfolio-selector:hover {
            border: 1px solid lightgrey;
        }

        .portfolio-selector:active, .portfolio-selector:focus {
            outline: none;
            box-shadow: none;
        }

        .portfolio-selector__container {
            margin: 5px auto;
            width: 100%;
            padding: 0 10px;
            border-bottom: 1px solid lightgray;
            position: relative;
        }

        .checked-portfolio {
            display: none;
            color: #4cd24c;
            font-size: 0.9vw;
        }

        .option-button {
            display: block;
            color: #ED4059;
            text-align: center;
            cursor: pointer;
            box-shadow: rgba(0, 0, 0, 0.1) 0px 3px 10px;
            border-radius: 5px;
            background: white;
            border-width: initial;
            border-style: none;
            border-color: initial;
            border-image: initial;
            padding: 10px;
            margin: 0px 10px;
            font: inherit;
            outline: none;
        }

        .option-button:hover {
            box-shadow: rgba(0, 0, 0, 0.15) 0px 5px 15px;
        }

        .gallery {
            position: relative;
            width: 100%;
            display: grid;
            grid-auto-flow: column;
            grid-template: auto auto none;
            gap: 20px 20px;
            padding: 8px 0px;
        }

        .gallery-item {
            width: 270px;
            max-width: 270px;
            transform: translate(0px, 0px);
            transition: transform 0.3s ease 0s;
            border-radius: 8px;
            font-weight: 300;
            letter-spacing: -0.2px;
            align-self: flex-start;
            display: grid;
            -webkit-box-align: stretch;
            align-items: stretch;
            max-width: 450px;
            word-break: break-word;
            background: rgb(248, 248, 248);
            border-radius: 0px 8px 8px 0px;
            overflow: hidden;
            grid-template: auto 100% none;
            gap: 10px 0px;
        }

        .gallery-item__header {
            width: 100%;
            box-sizing: border-box;
            min-height: 70px;
            position: relative;
            overflow: hidden;
            background: white;
            border-width: 1px;
            border-style: solid;
            border-color: rgba(51, 51, 51, 0.08);
            border-image: initial;
            border-radius: inherit;
            border-bottom-left-radius: 0px;
            border-bottom-right-radius: 0px;
        }

        .gallery-item__header img.card-header-img {
            width: auto;
            max-width: 100%;
            min-height: 70px;
            max-height: 230px;
            object-fit: cover;
            display: block;
            margin: 0px auto;
        }

        .gallery-switcher--right {
            right: -40px;
        }

        .gallery-switcher--left {
            left: -40px;
        }

        .gallery-switcher:hover {
            box-shadow: rgba(0, 0, 0, 0.25) 0px 10px 20px;
        }

        .gallery-switcher {
            position: absolute;
            z-index: 2;
            top: 30%;
            width: 40px;
            height: 40px;
            box-shadow: rgba(0, 0, 0, 0.05) 0px 5px 20px;
            cursor: pointer;
            padding: 0px;
            border-width: initial;
            border-style: none;
            border-color: initial;
            border-image: initial;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.95);
            outline: none;
        }

        .gallery-switcher:active, .gallery-switcher:focus {
            outline: none !important;
        }

        .gallery-switcher span {
            display: block;
            width: 40px;
            height: 40px;
            fill: #ED4059;
        }

        .gallery-switcher--right span {
            transform: rotate(90deg);
        }

        .gallery-switcher--left span {
            transform: rotate(270deg);
        }

        .chat-column .messages {
            display: flex;
            overflow-x: hidden;
            overflow-y: scroll;
            flex: 1 1 auto;
            flex-flow: column nowrap;
            padding: 0 10px;
        }

        .chat-column__form {
            display: flex;
            transform: translateY(0px);
            flex: 0 0 auto;
            padding: 10px 1%;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease 0s;
        }

        .chat-column__form textarea {
            height: 38px;
            z-index: auto;
            position: relative;
            line-height: 18.4px;
            font-size: 16px;
            transition: none 0s ease 0s;
            box-sizing: border-box;
            min-height: 40px;
            max-height: 50vh;
            width: 100%;
            resize: none;
            background-color: rgba(51, 51, 51, 0.05);
            color: rgb(51, 51, 51);
            -webkit-font-smoothing: antialiased;
            padding: 10px;
            border-width: initial;
            border-style: none;
            border-color: initial;
            border-image: initial;
            border-radius: 10px;
            font: inherit inherit inherit inherit inherit inherit inherit inherit inherit;
            overflow: hidden;
        }

        .chat-column__form textarea:focus {
            outline: none;
        }

        .chat-column__submit {
            font-size: 1.3em;
            padding-left: 8px;
            color: rgb(69, 193, 187);
            height: 40px;
            align-self: flex-end;
            display: flex;
            -webkit-box-pack: center;
            justify-content: center;
            -webkit-box-align: center;
            align-items: center;
            transition: all 0.2s ease-out 0s;
            width: 40px;
            -webkit-appearance: none;
            cursor: pointer;
            margin: 0px;
            overflow: visible;
            background: transparent;
            font: inherit inherit inherit inherit inherit inherit inherit inherit inherit;
            border-width: 0px;
            border-style: initial;
            border-color: initial;
            border-image: initial;
            padding: 0px;
        }

        .chat-column__submit:focus, .chat-column__submit:active {
            outline: none !important;
        }

        .chat-column__submit i {
            padding-left: 5px;
        }

        .chat-column__submit span {
            fill: rgb(69, 193, 187);
            width: 40px;
            height: 40px;
        }

        .loading-item {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin-right: 3px;
            background-color: #02233f;
            border-radius: 50%;
            animation: loading 1.3s linear 0s infinite normal none running;
        }

        .loading-item:nth-child(2) {
            animation-delay: -1.1s;
        }

        .loading-item:nth-child(3) {
            animation-delay: -0.9s;
        }

        .loading-items__container {
            border-radius: 0px 8px 8px;
            width: 70px;
            font-weight: 300;
            letter-spacing: -0.2px;
            align-self: flex-start;
            display: grid;
            -webkit-box-align: stretch;
            align-items: stretch;
            max-width: 450px;
            word-break: break-word;
            background: rgb(248, 248, 248);
            border-radius: 0px 8px 8px 0px;
            overflow: hidden;
            grid-template: auto / 100%;
            gap: 10px 0px;
        }

        .message-input {
            display: block;
            color: black;
            box-shadow: rgba(0, 0, 0, 0.1) 0px 3px 10px;
            border-radius: 5px;
            background: white;
            border-width: initial;
            border-style: none;
            border-color: initial;
            border-image: initial;
            padding: 10px;
            margin: 0px 10px 10px 10px;
            font: inherit;
            outline: none;
        }

        @keyframes loading {
            0%, 60%, 100% {
                transform: initial;
            }
            30% {
                transform: translateY(-6px);
            }
        }

        .attach-container {
            width: auto;
            height: auto;
            border-width: initial;
            border-style: none;
            border-color: initial;
            border-image: initial;
            position: relative;
        }

        .chat-column__attach {
            -webkit-appearance: button;
            margin-right: 5px;
            outline: none;
            cursor: pointer;
            height: 40px;
            align-self: flex-end;
            display: flex;
            -webkit-box-pack: center;
            justify-content: center;
            -webkit-box-align: center;
            align-items: center;
            transition: all 0.2s ease-out 0s;
            width: 40px;
            color: inherit;
            -webkit-appearance: none;
            margin: 0px;
            overflow: visible;
            background: transparent;
            font: inherit inherit inherit inherit inherit inherit inherit inherit inherit;
            border-width: 0px;
            border-style: initial;
            border-color: initial;
            border-image: initial;
            padding: 0px;
        }

        .chat-column__attach:focus {
            outline: none;
        }

        .chat-column__file-input {
            position: absolute;
            top: 0px;
            right: 0px;
            bottom: 0px;
            left: 0px;
            opacity: 1e-05;
            pointer-events: none;
        }

        .text-image {
            cursor: pointer;
        }

        .text-image:hover {
            opacity: 0.7;
        }

        /* The Modal (background) */
        .my-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            padding-top: 100px; /* Location of the box */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0, 0, 0); /* Fallback color */
            background-color: rgba(0, 0, 0, 0.9); /* Black w/ opacity */
        }

        /* Modal Content (Image) */
        .my-modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
        }

        /* Add Animation - Zoom in the Modal */
        .my-modal-content, #caption {
            animation-name: zoom;
            animation-duration: 0.6s;
        }

        @keyframes zoom {
            from {
                transform: scale(0)
            }
            to {
                transform: scale(1)
            }
        }

        /* The Close Button */
        .close-modal {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        .message__file-icon {
            display: block;
            color: black;
            font-size: 6em;
        }

        .message__file-link {
            color: black;
        }

        .message__file-link:hover {
            color: black;
        }

        /* 100% Image Width on Smaller Screens */
        @media only screen and (max-width: 700px) {
            .modal-content {
                width: 100%;
            }
        }

        .chat-column__scroll-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            position: absolute;
            right: 10px;
            bottom: 70px;
            cursor: pointer;
            outline: none;
        }

        .chat-column__scroll-button:hover {
            box-shadow: rgba(0, 0, 0, 0.15) 0px 5px 15px;
        }

        .chat-column__scroll-button:focus {
            outline: none;
        }

        .user-message {
            align-self: flex-end;
            grid-template: auto / calc(100% - 45px) 40px;
            padding: 0px 0px 20px 50px !important;
        }
        .user-message--concierge {
            grid-template: auto / calc(100%);
        }

        .user-message .sender {
            text-align: right;
            grid-row: 1;
            grid-column: 1;
        }

        .user-message .message-text-container {
            margin-right: 40px;
        }

        .user-message .user-avatar {
            grid-row: 1 / span 2;
            grid-column: 2;
        }

        .user-message .message-text-container .message-text .text {
            background: #02233f;
            color: #fff;
        }

        .user-message .message-text-container .message-text .text:last-child {
            border-radius: 8px 0 8px 8px;;
        }

        .user-message img.user-avatar {
            border-radius: 50%;
            float: right;
        }

        .drag-and-drop {
            width: 100%;
            height: 100%;
            background: rgba(124, 252, 0, 0.5);
            position: absolute;
            z-index: 3;
            font-size: 1.4em;
            color: black;
            display: flex;
            justify-content: center;
            align-content: center;
            flex-direction: column;
            text-align: center;
        }

        .uploaded-file__container {
            color: rgb(255, 255, 255);
            font-weight: 300;
            letter-spacing: -0.2px;
            align-self: flex-end;
            display: grid;
            -webkit-box-align: stretch;
            align-items: stretch;
            max-width: 450px;
            word-break: break-word;
            background: rgb(69, 193, 187);
            border-radius: 8px 0px 0px 8px;
            overflow: hidden;
            gap: 10px 0px;
        }

        .uploaded-file__container .file-content {
            width: 100%;
            box-sizing: border-box;
            min-height: 70px;
            /*position: relative;*/
            overflow: hidden;
            background: white;
            border-width: 1px;
            border-style: solid;
            border-color: rgba(51, 51, 51, 0.08);
            border-image: initial;
            border-radius: 8px 0px 0px 0;
        }

        .uploaded-file__container .file-content span {
            display: flex;
            position: relative;
            -webkit-box-pack: center;
            justify-content: center;
            -webkit-box-align: center;
            align-items: center;
            background-color: rgba(51, 51, 51, 0.08);
            /*width: 270px;*/
            height: 135px;
            margin: 0px;
        }

        .uploaded-file {
            display: block;
            position: relative;
            margin: 0px 0px 20px 90px;
        }

        .uploaded-file__info {
            margin: 10px;
        }

        .uploaded-file__info h1 {
            max-width: 100%;
            text-overflow: ellipsis;
            font-size: 16px;
            font-weight: 600;
            line-height: 20px;
            -webkit-font-smoothing: antialiased;
            margin: 0px;
            overflow: hidden;
        }

        .download-apps {
            width: 100%;
            height: 100vh;
            background-color: rgb(247, 247, 247);
        }

        .download-apps .description {
            position: absolute;
            left: 10%;
            top: 15%;
        }

        .download-apps h1 {
            max-width: 240px;
            font-size: 28px;
            font-weight: bold;
            color: rgb(55, 58, 124);
        }

        .app-links {
            bottom: 10%;
            left: 10%;
            position: absolute;
        }

        .app-links__description {
            max-width: 240px;
            font-size: 20px;
            font-weight: 600;
            color: rgb(55, 58, 124);
            margin-bottom: 20px;
        }

        .progress-ring {
            background: grey;
            border-radius: 50%;
            opacity: 0.7;
            position: absolute;
        }

        .progress-ring__circle {
            transition: 0.35s stroke-dashoffset;
            /*axis compensation*/
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            animation: spin 2s linear 0s infinite normal none running;
        }

        @-moz-keyframes spin {
            from {
                -moz-transform: rotate(0deg);
            }
            to {
                -moz-transform: rotate(360deg);
            }
        }

        @-webkit-keyframes spin {
            from {
                -webkit-transform: rotate(0deg);
            }
            to {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* CUSTOM SELECT */
        .select-hidden {
            display: none;
            visibility: hidden;
            padding-right: 10px;
        }

        .select {
            cursor: pointer;
            position: relative;
            font-size: 16px;
            color: rgb(51, 51, 51);
            width: 100%;
            height: 40px;
            display: none;
        }

        .select-styled {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(51, 51, 51, 0.07);
            border-radius: 8px;
            padding: 8px 15px;
            -moz-transition: all 0.2s ease-in;
            -o-transition: all 0.2s ease-in;
            -webkit-transition: all 0.2s ease-in;
            transition: all 0.2s ease-in;
        }

        .select-styled:after {
            content: "";
            width: 0;
            height: 0;
            border: 7px solid transparent;
            border-color: rgb(51, 51, 51) transparent transparent transparent;
            position: absolute;
            top: 16px;
            right: 10px;
        }

        .select-styled:active, .select-styled.active {
            background-color: rgba(51, 51, 51, 0.07);
        }

        .select-styled:active:after, .select-styled.active:after {
            top: 9px;
            border-color: transparent transparent rgb(51, 51, 51) transparent;
        }

        .select-options {
            position: absolute;
            top: auto;
            bottom: 100%;
            right: 0;
            left: 0;
            z-index: 999;
            margin: 0;
            padding: 0;
            list-style: none;
            max-height: 400px;
            overflow-y: scroll;
            overflow: auto;
            will-change: transform;
            background-color: white;
            height: 300px;
            box-shadow: rgba(0, 0, 0, 0.3) 0px 5px 25px -10px;
            border-radius: 10px;
            width: 15em;
            border: none;
        }

        .select-options li {
            margin: 0;
            padding: 12px 0;
            text-indent: 15px;
            border-top: grey;
            -moz-transition: all 0.15s ease-in;
            -o-transition: all 0.15s ease-in;
            -webkit-transition: all 0.15s ease-in;
            transition: all 0.15s ease-in;
            color: rgba(51, 51, 51, 0.5);
        }

        .select-options li:hover {
            background: rgba(51, 51, 51, 0.1);
        }

        .select-options li[rel="hide"] {
            display: none;
        }

        /* CUSTOM SELECT END*/
        ::-webkit-scrollbar {
            width: 0; /* remove scrollbar space */
            background: transparent; /* optional: just make scrollbar invisible */
        }

        .footer-buttons {
            position: static;
            bottom: 0;
            width: 100%;
        }

        /*@media (max-width: 1100px) {*/
        /*.footer-buttons {*/
        /*position: relative;*/
        /*}*/
        /*}*/
        /*@media (max-height: 1100px) {*/
        /*.footer-buttons {*/
        /*position: relative;*/
        /*}*/
        /*}*/

        .footer-buttons a {
            font-size: 1.15em;
            color: rgb(74, 80, 90);
            margin-top: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .footer-buttons a i {
            font-size: 0.6em;
        }

        .footer-buttons a:hover, .footer-buttons a:active {
            text-decoration: none;
        }

        .portfolio-selector__thumb {
            display: inline;
            width: 10%;
            border-radius: .25rem;
            cursor: pointer;
        }

        /* The sticky class is added to the navbar with JS when it reaches its scroll position */
        .sticky {
            position: fixed;
            top: 42px;
            width: 100%;
        }

        .sticky + .content {
            padding-top: 45px;
        }

        #search-input:active, #search-input:focus {
            outline: none;
            -webkit-box-shadow: none;
            -moz-box-shadow: none;
            box-shadow: none;
        }

        .tabs__sticky {
            position: fixed;
            top: 0;
            width: 40.4vw;
        }

        .nav-tabs .nav-link {
            background: rgb(247, 247, 247);
        }

        .nav-link img {
            width: 1rem;
        }

        .message-container__date {
            position: sticky;
            top: 20px;
            z-index: 20;
            margin-bottom: 20px;
            height: 20px;
            line-height: 20px;
            color: rgb(181, 181, 181);
            font-size: 13px;
            white-space: nowrap;
            text-align: center;
            align-self: center;
            padding: 0px 20px;
            border-radius: 10px;
            background: rgb(255, 255, 255);
        }

        .channel-user {
            display: flex;
            flex-direction: row;
            padding: 10px 0;
            justify-content: flex-start; /* align items in Main Axis */
            align-items: stretch; /* align items in Cross Axis */
            align-content: stretch; /* Extra space in Cross Axis */
        }

        .channel-user__avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }

        .channel-user__name {
            flex: 1;
        }

        .channel-user__status {
            color: grey;
        }

        .channel-user__status.online {
            color: forestgreen;
        }

        #open-file__url {
            background: #ED4059;
            position: absolute;
            top: 30px;
            margin: 0 auto;
            text-align: center;
            padding: 5px 0;
            left: 0;
            right: 0;
            width: 122px;
            border-radius: 8px;
        }

        #open-file__url:hover {
            text-decoration: none;
        }

        .messages-loader {
            width: 10%;
            margin: auto;
        }

        .messages-loader img {
            width: 100%;
        }

        #new-user-id {
            margin-top: 15px;
        }

        .user-operation {
            width: 33px;
            margin-top: 7px;
            padding-left: 0;
            padding-right: 0;
        }

        .user-operation img {
            width: 100%;
        }

        #user-invite {
            margin-right: 20px;
        }

        .user-operation__container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-name__container {
            flex: 1;
            display: flex;
            border-bottom: 1px solid lightgrey;
            margin-left: 10px;
            align-items: center;
        }

        #js-form-submit {
            /*margin-left: 8px;*/
        }

        .js-sync-button {
            margin-left: 5px;
            cursor: pointer;
            display: none;
        }

        .js-sync-button:hover {
            background: lightgray;
        }

        .portfolio-syncing {
            animation: spin 2s linear 0s infinite normal none running;
        }

        #add-portfolio-submit {
            margin: auto;
        }

        #concierge-page__side-column {
            display: flex;
            flex: 4.5 3 300px;
            overflow: scroll;
            flex-direction: column;
            background: #02233f;
        }

        .file-delete {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            color: red;
        }

        .channel-info {
            font-size: 0.8em;
        }

        .channel-info__author {
            font-weight: bold;
            display: inline;
        }

        .channel-info__message {
            display: inline;
        }

        .channel-info__date {
            display: block;
        }

        .portfolio-selector > .badge {
            position: absolute;
            top: 8px;
            right: 3em;
        }

        .image-message {
            height: 300px;
        }

    </style>
</head>

<body>

<div class="download-apps js-column" style="display: none">
    <div style="position: relative; height: 100%; width: 100%;">
        <div class="description">
            <span>
                <svg style="width: 38%"
                    class="SVGInline-svg MobileLayoutstyled__Computer-eVqQfH-svg gKrebw-svg"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 144 70"><path fill="none" d="M0 0h144v69.981H0z"></path><path fill="#373A7C"
                    d="M28.66 52.394c-.305.975-.632 2.08-.162 2.991.611 1.142 2.086 1.38 3.36 1.479 3.054.237 6.081.475 9.123.691a656.307 656.307 0 0 0 79.314.846c2.837-.139 5.965-.429 7.92-2.513.959-1.018 1.505-2.355 2.022-3.661A268.87 268.87 0 0 0 143.7 6.95c.354-1.75.611-3.788-.535-5.137-.916-1.05-2.391-1.318-3.759-1.466-7.612-.828-15.272.04-22.929.398-21.053.988-42.21-1.893-63.187.151-1.915.188-3.891.435-5.544 1.43-2.81 1.685-3.665 6.67-4.777 9.57a983.162 983.162 0 0 0-5.088 13.789 1004.384 1004.384 0 0 0-9.22 26.709z"></path><path
                    fill="#8CF1FA"
                    d="M34.013 50.322c-.301.888-.575 1.894-.145 2.72.539 1.04 1.89 1.253 3.046 1.344 2.756.217 5.513.433 8.273.632a594.9 594.9 0 0 0 71.925.768c2.573-.128 5.417-.393 7.183-2.287.87-.914 1.367-2.134 1.833-3.326a244.668 244.668 0 0 0 12.209-41.16c.325-1.594.572-3.444-.484-4.67-.819-.954-2.167-1.198-3.41-1.335-6.9-.753-13.861.036-20.795.362-19.095.897-38.283-1.72-57.308.14-1.737.168-3.528.394-5.03 1.296-2.548 1.525-3.334 6.068-4.33 8.71a914.484 914.484 0 0 0-4.598 12.525 903.871 903.871 0 0 0-8.37 24.281z"></path><path
                    fill="#373A7C"
                    d="M6.966 56.048c-2.033-.109-4.334-.156-5.783 1.232C-.732 59.12.044 62.214.96 64.672c.305.8.64 1.654 1.373 2.126.554.353 1.24.43 1.9.495a553.54 553.54 0 0 0 110.104-.112c3.327-.336 7.09-.955 8.916-3.667.798-1.179.844-3.16-.529-3.646a3.297 3.297 0 0 0-1.142-.112c-26.008.519-51.652-4.462-77.703-3.142-2.13-.698-4.292-1.624-6.335-1.403-3.338.362-6.687.635-10.045.82-6.839.374-13.693.38-20.533.017z"></path><path
                    fill="#FADE39"
                    d="M90.65 33.51l11.63-1.901-.614-15.21c-.04-.933-.099-1.922-.645-2.686-3.883-5.41-27.227-1.707-32.802-1.75-14.342-.111-28.685-.332-43.027-.332-1.149 0-2.34 0-3.393.444-3.377 1.454-3.257 6.155-2.566 9.728l3.702 19.069c10.088 2.064 20.486-.35 30.675-1.983 10.188-1.632 21.252-2.296 30.183 2.767 2.94 1.669 5.765 3.986 9.157 4.1-.537-1.562-2.747-10.665-2.3-12.246z"></path><path
                    fill="#373A7C"
                    d="M43.739 30.953c4.486 0 4.486-6.729 0-6.729s-4.486 6.73 0 6.73zM62.58 28.261c4.485 0 4.485-6.729 0-6.729-4.487 0-4.487 6.73 0 6.73zM80.075 25.57c4.486 0 4.486-6.73 0-6.73s-4.486 6.73 0 6.73z"></path></svg>
            </span>
            <h1>
                <span style="color: rgb(41, 120, 253);">OMNE</span> was designed to be beautiful on a big screen. Try
                it on a desktop
            </h1>
        </div>
        <div class="app-links">
            <div class="app-links__description">
                Or be mobile and download <span style="color: rgb(41, 120, 253);">OMNE app</span>
            </div>
            <a href="" target="_blank">
                <span>
                    <img style="width: 48%"
                        data-src="https://play.google.com/intl/en_us/badges/images/generic/en_badge_web_generic.png"
                        alt=""
                        class="lozad">
                </span>
            </a>
            <a href="" target="_blank">
                <span>
                    <img style="width: 48%"
                        data-src="https://vignette.wikia.nocookie.net/central/images/4/46/App_Store.svg/revision/latest?cb=20171003160143"
                        alt=""
                        class="lozad">
                </span>
            </a>
        </div>
    </div>
</div>

<div id="loader-overlay" style="position: fixed; left: 0px; top: 0px; width: 100%; height: 100%; z-index: 9999; background: white">
    <img src="/img/loader-red.gif" alt="" style="    position: absolute; top: 50%; left: 50%; width: 200px; height: 200px; margin-top: -100px; margin-left: -100px;">
</div>

<!-- Modal -->
<div class="modal fade"
    id="exampleModal"
    tabindex="-1"
    role="dialog"
    aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Team</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Loading...
            </div>
        </div>
    </div>
</div>

<div id="message-templates">
    <div class="responder-message-container user-message js-chat-message">
        <img src="" alt="" class="user-avatar">
        <div class="sender js-sent-at">Hehe, 12:12</div>
        <div class="message-text-container">
            <div class="message-text">
                <button class="option-button" style="display: none"></button>
                <input type="text" class="message-input js-message-input" style="display: none">
                <div class="text" data-payload="wb_01_start">
                    <div class="js-message-text"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="messages-loader" style="display: none">
        <img src="/static/img/loader.gif" alt="">
    </div>

    <div class="responder-message-container js-chat-message">
        <img src="" alt="" class="user-avatar">
        <div class="sender js-sent-at">Hehe, 12:12</div>
        <div class="message-text-container">
            <div class="message-text">
                <button class="option-button" style="display: none"></button>
                <input type="text" class="message-input js-message-input" style="display: none">
                <div class="text" data-payload="wb_01_start">
                    <div class="js-message-text"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="responder-message-container js-cards-container js-chat-message" style="display: none">
        <img src="" alt="" class="user-avatar">
        <div class="sender js-sent-at">Hehe, 12:12</div>
        <div class="message-text-container">
            <div class="gallery">
                <div class="gallery-item" style="display: none">
                    <div class="gallery-item__header">
                        <img data-src="https://www.osome.com/img/bot2/sec/sec_1_year.png"
                            alt=""
                            class="card-header-img lozad">
                    </div>
                    <div class="message-text">
                        <div class="text js-text-container" data-payload="wb_01_start">
                            <div class="js-message-text"></div>
                            <button class="option-button" style="display: none"></button>
                        </div>
                    </div>
                </div>
                <button class="gallery-switcher gallery-switcher--right">
                    <span>
                        <svg class="SVGInline-svg Gallerystyled__StyledArrowSvg-bMzhOr-svg kzmuKH-svg"
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="2 -3 36 36"><path d="M20 8l-9 9 1.5 1.5L20 11l7.5 7.5L29 17z"></path></svg>
                    </span>
                </button>

                <button class="gallery-switcher gallery-switcher--left" style="display: none">
                    <span>
                        <svg class="SVGInline-svg Gallerystyled__StyledArrowSvg-bMzhOr-svg kzmuKH-svg"
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="2 -3 36 36"><path d="M20 8l-9 9 1.5 1.5L20 11l7.5 7.5L29 17z"></path></svg>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <div class="responder-message-container js-loading">
        <img src="https://www.omne.ai/img/favicon-32x32.png" alt="" class="user-avatar">
        <div class="sender js-sent-at"></div>
        <div style=" display: flex; flex-direction: column;">
            <div class="loading-items__container">
                <div style="margin: 10px">
                    <div class="loading-item"></div>
                    <div class="loading-item"></div>
                    <div class="loading-item"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="message-container__date" id="js-date-container">
        10 December
    </div>

    <div class="uploaded-file">
        <div class="uploaded-file__container">
            <div class="file-content">
                <span>
                    <svg
                        class="progress-ring"
                        width="100"
                        height="100">
                      <circle
                          class="progress-ring__circle"
                          stroke="white"
                          stroke-width="2"
                          fill="transparent"
                          r="46"
                          cx="50"
                          cy="50"
                      ></circle>
                    </svg>
                    <img data-src="/static/img/file-32x32.png" style="height: 100%" />
                </span>
            </div>
            <header class="uploaded-file__info">
                <h1>filename yo</h1>
            </header>
        </div>
    </div>

</div>

{% for doc in documents %}
<div class="doc-content">{{doc}}</div>
{% endfor %}

<div class="side-column js-column">
    <div id="sidebar-avatar">
        <img class="lozad"
            data-src="{{profile_pic}}"
            id="avatar"
            alt="OMNE"
            style="height: 100px; width: 100px; display: flex"/>
        <input type="file" class="hidden" id="avatar-file-input">

        <div class="user-data__container">
            <h1 id="user-id">{{userId}}</h1>
            <h1 id="user-nickname"></h1>
        </div>
    </div>
    <div id="control-buttons">
        <button class="btn btn-default" id="load-more-button">Load more</button>
    </div>

    <div class="footer-buttons">
        <a class="btn btn-link btn-lg btn-block" href="#" id="add-portfolio">
            <i class="fas fa-plus" data-toggle="modal" data-target="#new-portfolio-modal"></i>&nbsp;
            Aggiungi Attività
        </a>
        <a class="btn btn-link btn-lg btn-block" href="/logout"><i class="fas fa-sign-out-alt"></i>&nbsp;Logout</a>
    </div>

</div>

<div class="chat-column js-column" id="js-chat-column">

    <div class="drag-and-drop" style="display: none">
        <div>
            Trascina i file qui
        </div>
    </div>

    <form action="" class="chat-column__form" id="js-chat-form">
        <div class="attach-container">
            <button class="chat-column__attach">
                <img src="/static/img/attachment_pic.png" alt="" style="width: 60%">
            </button>
            <input type="file" class="chat-column__file-input">
        </div>
        <textarea name="" id="" cols="30" rows="10" placeholder="Type a message" class="js-chat-input"></textarea>
        <button class="chat-column__submit" id="js-users-list-button" data-toggle="modal" data-target="#exampleModal">
            <img src="/static/img/dots.png" alt="" style="width: 60%">
        </button>
        <button class="chat-column__submit" id="js-invoice-button" data-toggle="modal" data-target="#invoice-modal">
            <img src="/static/img/invoice.png" alt="" style="width: 60%">
        </button>
        <button class="chat-column__submit" id="js-form-submit">
            <img src="/static/img/envelope.png" alt="" style="width: 80%">
        </button>
    </form>
    <button class="chat-column__scroll-button js-chat-scroll">
        <i class="fas fa-angle-down"></i>
    </button>
    <input id="fileupload" type="file" name="file[]" multiple style="display: none">
</div>

<!-- The Modal -->
<div id="myModal" class="my-modal">
    <a href="" id="open-file__url">
        📑
    </a>
    <!-- The Close Button -->
    <span class="close-modal">&times;</span>
    <!-- Modal Content (The Image) -->
    <img class="my-modal-content" id="img01">
</div>

<div id="concierge-page__side-column" style="display: none">
    <iframe id="concierge-iframe" style="border: none; height: 100%"></iframe>
</div>

<div id="graphs-container" class="js-column">
    <div style="z-index: 999;">
        <ul class="nav nav-tabs nav-justified" role="tablist">
            <li class="nav-item">
                <a role="tab" data-toggle="tab" class="nav-link active" href="#docs">
                    <img src="/static/img/file.png" alt="">
                </a>
            </li>
            <li class="nav-item">
                <a role="tab" data-toggle="tab" class="nav-link" href="#graphs">
                    <img src="/static/img/statistics.png" alt="">
                </a>
            </li>
            <li class="nav-item" style="display: none">
                <a role="tab" data-toggle="tab" class="nav-link" href="#pies">
                    <img src="/static/img/pie-chart.png" alt="">
                </a>
            </li>
            <li class="nav-item" style="display: none">
                <a role="tab" data-toggle="tab" class="nav-link" href="#graphs-1">
                    <img src="/static/img/1-a.png" alt="">
                </a>
            </li>
            <li class="nav-item">
                <a role="tab" data-toggle="tab" class="nav-link" href="#graphs-2">
                    <img src="/static/img/2-a.png" alt="">
                </a>
            </li>
        </ul>
    </div>
    <div class="container tab-content" data-aos="fade-left" data-aos-once="true">
        <div role="tabpanel" class="tab-pane active" id="docs">
            <div class="input-group md-form form-sm form-1 pl-0" id="search-bar">
                <div class="input-group-prepend">
                    <span class="input-group-text purple lighten-3" id="basic-text1">
                        <i class="fa fa-search text-white" aria-hidden="true"></i>
                    </span>
                </div>
                <input class="form-control my-0 py-1"
                    type="text"
                    placeholder="Search"
                    aria-label="Search"
                    id="search-input">
            </div>
            <div class="content">
                <div class="file-container hidden">
                    <div class="file-data">
                        <div class="file-preview">

                        </div>
                        <div class="file-description">
                            <div class="file-description__filename"></div>
                            <div class="file-description__text"></div>
                            <a class="file-description__link" href="" target="_blank"></a>
                        </div>
                    </div>
                    <div class="file-delete">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
                <div class="file-container--empty hidden" id="file-container--empty">
                    There are no files
                </div>
            </div>
        </div>
        <div role="tabpanel" class="about__row tab-pane" id="graphs">
        </div>
        <div role="tabpanel" class="tab-pane" id="pies">
        </div>
        <div role="tabpanel" class="tab-pane" id="graphs-1">
        </div>
        <div role="tabpanel" class="tab-pane" id="graphs-2">
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade"
    id="new-portfolio-modal"
    tabindex="-1"
    role="dialog"
    aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crea Attività</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-portfolio-name" class="col-form-label">Nome dell'attività:</label>
                    <input type="text" class="form-control" id="new-portfolio-name">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="add-portfolio-submit">Crea</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade"
    id="invoice-modal"
    tabindex="-1"
    role="dialog"
    aria-labelledby="invoice-label"
    aria-hidden="true">
    <div class="modal-dialog" role="document" style="height: 85%">
        <div class="modal-content" style="height: 100%">
            <div class="modal-header">
                <h5 class="modal-title" id="invoice-label">Invoice</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="height: 90%; overflow: scroll;">
                <iframe id="invoice-generator" style="border: none; height: 100%; width: 100%;"></iframe>
            </div>
        </div>
    </div>
</div>

<div id="portfolioData" style="display: none">{{portList | safe}}</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<!-- Plotly.js -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://unpkg.com/popper.js/dist/umd/popper.min.js"></script>
<script src="https://unpkg.com/tooltip.js/dist/umd/tooltip.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
    integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>
<script type="text/javascript" src="/static/js/jquery.ui.widget.js"></script>
<script type="text/javascript" src="/static/js/jquery.iframe-transport.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/blueimp-file-upload/9.5.2/jquery.fileupload.min.js"></script>
<script src="https://checkout.stripe.com/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

<script type="text/javascript">
    var isConciergePage = window.location.pathname === '/concierge';
    if (isConciergePage) {
        $('.nav-item').each(function (index, item) {
            if (index !== 0) {
                $(item).hide();
            }
        });
        $('.side-column').first().hide();
        $('body').css('flex-direction', 'row-reverse');
        $('#graphs-container').hide();
        $('#concierge-page__side-column').show();
        $('#js-users-list-button').hide();
        $('#js-invoice-button').hide();
    }

    var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    var userObject = {{userObj | safe}};
    var userId = '{{userId | safe}}';
    if (isConciergePage) {
        userId = userObject.nickname;
    }

    var iframe = document.getElementById('invoice-generator');

    $('#user-nickname').text(userObject.nickname);
    var $avatar = $('#avatar');
    if (isConciergePage) {
        $avatar.attr('data-src', 'https://www.pythonanywhere.com/user/giovannipiccinelli/files/home/giovannipiccinelli/mybot/static/favicon-96x96.png');
        $('#user-id').text('GUEST');
    }
    $avatar.attr('data-src', userObject.profile_pic);
    var channels = {{channels | safe}};
    var $lastMessage = null;
    var $portfolioData = $('#portfolioData');
    var portfolioData = eval($portfolioData.text());
    $portfolioData.remove();

    var scrollHandler = function () {
        shouldUseInverseMode = false;
        if ($(this).scrollTop() === 0 && ($(this).prop('scrollHeight') > $(window).height())) {
            $lastMessage = $('#' + channelId + '>div:visible').first();
            shouldUseInverseMode = true;
            var $loader = $('.messages-loader').first().clone();
            $loader.insertBefore($lastMessage);
            $loader.show();
            channelQueries[channelId].load(loadMessages);
        }
    };

    var apiPostMessageUrl = isConciergePage ? '/postjson' : '/postjson';
    var isOldTitle = true;
    var oldTitle = $(document).find("title").text();
    var oldFavicon = $('#favicon').attr('href');
    var newTitle = 'New message received';
    var newFavicon = 'notification.png';
    var jsChatColumn = $('#js-chat-column');
    var interval = null;
    var modal = $('#myModal');

    var channelId = isConciergePage ? channels.channel_url : portfolioData[0].channelId;
    var channelIdFromQuery = new URLSearchParams(window.location.search).get('channelId');
    var cookieValue = Cookies.get('channelId');
    if (cookieValue !== undefined && !isConciergePage) {
        channelId = cookieValue;
    }
    if (channelIdFromQuery) {
        channelId = channelIdFromQuery;
    }
    window.channelId = channelId;
    iframe.contentWindow.location.reload();

    // window.channelIds = portfolioData;

    var hiddenContainers = [];

    if (!isConciergePage) {
        renderPortfolios(portfolioData);
    } else {
        renderConciergeMessagesContainer();
    }

    function renderConciergeMessagesContainer() {
        var $messagesContainer = $('<div></div>');
        $messagesContainer.attr('class', 'messages');
        $messagesContainer.attr('id', channelId);
        $messagesContainer.prependTo(jsChatColumn);
        $messagesContainer.on('scroll', scrollHandler);
    }

    function renderPortfolios(portfolioData) {
        for (var i in portfolioData) {
            var portfolioChannelId = portfolioData[i].channelId;
            var $messagesContainer = $('<div></div>');
            $messagesContainer.attr('class', 'messages');
            $messagesContainer.attr('id', portfolioChannelId);
            if (portfolioChannelId !== channelId) {
                hiddenContainers[portfolioChannelId] = $messagesContainer;
            } else {
                $messagesContainer.on('scroll', scrollHandler);
                $messagesContainer.prependTo(jsChatColumn);
            }

            var thumbSrc = portfolioData[i].thumb;
            var selectorBtnContainer = $("<div class='portfolio-selector__container'>" +
                "<img class='portfolio-selector__thumb js-portfolio-image' src='" + thumbSrc + "' alt='thumb'>" +
                "<input type='file' class='js-portfolio-image-input hidden'>"+
                "<img class='portfolio-selector__thumb js-sync-button' src='/static/img/sync.png'>" +
                "<button class='portfolio-selector btn btn-default'></button><i class='fas fa-check checked-portfolio'></i>" +
                "<div class='channel-info'><div class='channel-info__author'>Author</div>: " +
                "<div class='channel-info__message'><span class='chanel-info__message-body'>message</span>" +
                "<span class='channel-info__date'>1/1/2019</span></div>" +
                "</div>");
            var $selectorBtn = selectorBtnContainer.find('.portfolio-selector');
            var portfolioName = portfolioData[i].name;
            var syncButton = selectorBtnContainer.find('.js-sync-button');
            $('.js-portfolio-image').attr('data-channelId', portfolioChannelId);
            $('.js-portfolio-image-input').attr('data-channelId', portfolioChannelId);
            selectorBtnContainer.find('.channel-info__author').first().text(portfolioData[i].channelData.last_msg_user);
            var lastMsgText = portfolioData[i].channelData.last_msg;
            if (lastMsgText.charAt(0) === '{') {
                lastMsgText = 'message';
            }
            if (lastMsgText.length > 20) {
                lastMsgText = lastMsgText.substring(0, 20) + '...';
            }
            selectorBtnContainer.find('.chanel-info__message-body').first().text(lastMsgText);
            selectorBtnContainer.find('.channel-info__date').first().text(portfolioData[i].channelData.last_msg_created_at);

            var btnText = "<span class='portfolio-selector__text'>" + portfolioData[i].name + "</span>";
            var messagesCount = portfolioData[i].channelData.unread_messages_count;
            if (portfolioChannelId !== channelId && messagesCount > 0) {
                btnText = "<span class='portfolio-selector__text'>" + portfolioData[i].name + "</span>"
                    + "<span class='badge badge-pill badge-primary'>" + messagesCount + "</span>";
            }
            $selectorBtn.html(btnText);
            $selectorBtn.attr('data-channelId', portfolioChannelId);
            $selectorBtn.attr('data-portfolioName', portfolioName);
            syncButton.attr('data-channelId', portfolioChannelId);
            if (portfolioChannelId === channelId) {
                selectorBtnContainer.find('.checked-portfolio').first().css('display', 'inline-block');
            }

            selectorBtnContainer.insertBefore('#load-more-button');
        }
    }

    var displayedDocs = [];
    var graphIdPortfolioNameMapping = [];

    var graphsCounter = 0;
    function initGraphs(portfolioData) {
        var graphsContainer = $('#graphs-container').first();
        var width = graphsContainer.width();
        var height = (graphsContainer.height() / 2) - 30;
        for (var i in portfolioData) {
            var graphsData = JSON.parse(portfolioData[i].graphs);
            for (var j in graphsData) {
                var graphDiv = $('<div></div>');
                graphDiv.attr('data-portfolioName', portfolioData[i].name);
                var id = 'graph-' + graphsCounter;
                graphsCounter++;
                graphDiv.attr('id', id);
                graphDiv.appendTo($('#graphs'));
                var graphData = graphsData[j];
                if (!graphData) {
                    continue;
                }
                var layout = graphData.layout;
                var type = "";
                if (graphData.data[0] !== undefined) {
                    type = '' + graphData.data[0].type;
                }
                var isPie = type == 'pie';
                layout.width = width;
                layout.height = height;
                var title = graphData.layout.title;
                graphData.layout.title = sanitizeName(graphData.layout.title);
                if (isPie) {
                    $('#' + id).detach().appendTo('#pies');
                    graphData.data[0].domain.x[1] = 1;
                }
                // if (parseInt(j) === 4 || parseInt(j) === 5) {
                //     $('#' + id).detach().appendTo('#graphs-1');
                // }
                if (parseInt(j) === 2 || parseInt(j) === 3) {
                    $('#' + id).detach().appendTo('#graphs-2');
                }
                layout.align = 'center';
                Plotly.plot(
                    id, // the ID of the div, created above
                    graphData.data,
                    layout
                );
                graphIdPortfolioNameMapping['#' + id] = title;
                var graph = $('#' + id);
                if (parseInt(i) !== 0) {
                    graph.hide();
                }
            }
        }
        $(window).trigger('resize');
    }

    function initDocs() {
        $('.doc-content').each(function (index, item) {
            var filesInfo = JSON.parse($(item).text().replace(/'/g, '"'));
            renderChannelFiles(filesInfo);
            $(item).remove();
        });
        var empty = $('#file-container--empty');
        if (displayedDocs.length === 0) {
            empty.removeClass('hidden');
        } else {
            empty.addClass('hidden');
        }
    }

    function renderChannelFiles(filesInfo) {
        var filesChannelId = Object.keys(filesInfo)[0];
        var files = filesInfo[filesChannelId];
        for (var i in files) {
            renderDoc(filesChannelId, files[i].name, files[i].posted_by, files[i].created_date, files[i].url, files[i].thumb, false);
        }
    }

    function renderDoc(filesChannelId, filename, postedBy, createdDate, url, thumbImage, shouldPrepend) {
        var container = $('.file-container.hidden').first().clone();
        container.removeClass('hidden');
        if (filesChannelId != channelId) {
            container.hide();
        } else {
            displayedDocs.push(container);
        }
        container.find('.file-description__filename').first().text(filename);
        container.find('.file-description__text').first().text('By: ' + postedBy + ', on ' + createdDate);
        container.find('.file-description__link').first().attr('href', url);
        var thumb = container.find('.file-preview');
        var $img = $('<img/>');
        $img.attr('data-src', thumbImage);
        $img.appendTo(thumb);
        $img.addClass('lozad');

        container.attr('data-channelId', filesChannelId);
        var $docs = $('#docs');
        if (shouldPrepend) {
            container.insertAfter($('#search-bar'));
        } else {
            $docs.append(container);
        }
    }

    $(document).on('click', '.file-data', function () {
        var link = $(this).find('.file-description__link').first().attr('href');
        var win = window.open(link, '_blank');
        win.focus();
    });

    if (!isConciergePage) {
        initGraphs(portfolioData);
    }
    initDocs();
    initSendBird();

    $(document).on('click', '.portfolio-selector', function () {
        $(this).find('.badge').first().hide();
        channelId = $(this).attr('data-channelId');
        window.channelId = channelId;
        iframe.contentWindow.location.reload();
        Cookies.set('channelId', channelId);
        $('#search-input').val('');
        for (var index in graphIdPortfolioNameMapping) {
            var graphContainer = $(index.toString());
            if ($.trim(graphContainer.attr('data-portfolioName')) === $.trim($(this).find('.portfolio-selector__text').first().text())) {
                graphContainer.show();
            } else {
                graphContainer.hide();
            }
        }
        $('.messages').each(function (index, item) {
            hiddenContainers[$(item).attr('id')] = $(item);
            $(item).remove();
        });
        var x = hiddenContainers[channelId];
        x.prependTo(jsChatColumn);
        x.on('scroll', scrollHandler);
        $messagesContainer = $('#' + channelId);
        $messagesContainer.show();
        $('.checked-portfolio').css('display', 'none');
        $(this).next('.checked-portfolio').css('display', 'inline-block');

        var files = $('.file-container');
        var visibleFiles = 0;
        displayedDocs = [];
        files.each(function (index, item) {
            var $item = $(item);
            if ($item.attr('data-channelId') != undefined) {
                if ($item.attr('data-channelId') != channelId) {
                    $item.hide();
                } else {
                    $item.show();
                    displayedDocs.push($item);
                    visibleFiles++;
                }
            }
        });
        var empty = $('#file-container--empty');
        if (visibleFiles === 0) {
            empty.removeClass('hidden');
        } else {
            empty.addClass('hidden');
        }
        window.dispatchEvent(new Event('resize'));
        var data = {
            userId: userId,
            channelId: channelId
        };
        $('.js-loading').hide();
        $.post('mark_read', JSON.stringify(data));
        scrollChatToBottom();
        var observer = lozad();
        observer.observe();
    });

    $(window).on('resize', function () {
        var $downloadApps = $('.download-apps').first();
        if ($(window).width() < 700 || mobileCheck()) {
            $('.js-column').each(function (index, item) {
                $(item).hide();
            });
            $downloadApps.show();
            return;
        } else {
            $('.js-column').each(function (index, item) {
                if (isConciergePage && ($(item).attr('id') === 'graphs-container') || $(item).hasClass('side-column')) {
                    return;
                }
                $(item).css('display', 'flex');
            });
            $downloadApps.hide();
        }
        var container = $('#graphs-container');
        var width = container.width();
        var height = (container.height() / 2) - 30;
        var graphsCounter = 0;
        for (var i in portfolioData) {
            var graphsData = JSON.parse(portfolioData[i].graphs);
            for (var j in graphsData) {
                if (!$('#graph-' + graphsCounter).is(':hidden')) {
                    Plotly.relayout('graph-' + graphsCounter, {
                        width: width,
                        height: height,
                        align: 'center'
                    });
                }
                graphsCounter++;
            }
        }
    });

    $("#search-input").on('input propertychange', function (event) {
        var filterValue = $(event.target).val().toString().toUpperCase();
        for (var i in displayedDocs) {
            var $item = displayedDocs[i];
            if ($item.find('.file-description__filename').first().text().toUpperCase().indexOf(filterValue) > -1) {
                $item.show();
            } else {
                $item.hide();
            }
        }
    });

    function sanitizeName(name) {
        if (name === undefined) {
            return '';
        }
        name = name.toString();
        if (name.indexOf('_') === -1) {
            return name;
        }
        return name.substring(0, name.indexOf('_'));
    }

    var sendBirdWasInitialized = false;
    var lastDisplayedMessage = null;
    var channels = [];
    var messageForOptions;
    var shouldUseInverseMode = false;

    var sendbird = null;
    var channelQueries = [];
    var channelsCount = 0;
    var messagesLimit = 40;

    function initSendBird() {
        var appId = isConciergePage ? '9A997118-6C53-4FA2-AEAA-C335293220B2' : '9A997118-6C53-4FA2-AEAA-C335293220B2';
        var sb = new SendBird({ appId: appId });
        if (isConciergePage) {
            sb.connect(userId, function (user, error) {
                if (error) {
                    console.error(error);
                    return;
                }
            });
        } else {
            sb.connect(userId, userObject.sbToken, function (user, error) {
                if (error) {
                    console.error(error);
                    return;
                }
            });
        }

        sendbird = sb;
        var ChannelHandler = new sb.ChannelHandler();

        ChannelHandler.onMessageReceived = function (channel, message) {
            var $typingIndicatorSelector = $('.js-loading');
            $typingIndicatorSelector.each(function (index, item) {
                if ($(item).attr('data-userId') == message.sender.userId) {
                    $(item).hide();
                }
            });
            var channelButton = $('button[data-channelid="' + channel.url +'"]');
            var unreadMessageCount = parseInt(channel.unreadMessageCount);
            var senderNickname = channel.lastMessage.sender ? channel.lastMessage.sender.nickname : 'admin';
            if (unreadMessageCount > 1 && channel.url != channelId) {
                var buttonBadge = channelButton.find('.badge-pill');
                if (!buttonBadge.length) {
                    var btnText = "<span class='badge badge-pill badge-primary'>" + unreadMessageCount + "</span>";
                    channelButton.append(btnText);
                } else {
                    buttonBadge.text(channel.unreadMessageCount);
                }
                buttonBadge.show();
                var lastMessageText = channel.lastMessage.message;
                if (lastMessageText.charAt(0) === '{') {
                    lastMessageText = 'message';
                }
                if (lastMessageText.length > 20) {
                    lastMessageText = lastMessageText.substring(0, 20) + '...';
                }
                channelButton.siblings().find('.channel-info__author').text(senderNickname);
                channelButton.siblings().find('.chanel-info__message-body').text(lastMessageText);
                channelButton.siblings().find('.channel-info__date').text(new Date(channel.lastMessage.createdAt).toGMTString());
            }
            if (message.data.length > 0 && JSON.parse(message.data.replace(/'/g, '"')).isOptionsMessage == true) {
                messageForOptions = message;
                return;
            }
            shouldUseInverseMode = false;
            parseMessage(message, messageForOptions, null, true);
            messageForOptions = null;
            scrollChatToBottom();
            newTitle = 'New message from ' + senderNickname;
            if (!document.hasFocus() && !interval) {
                interval = setInterval(changeTitle, 700);
            }
            var audio = new Audio('/static/audio/ring.mp3');
            audio.play();
        };

        ChannelHandler.onTypingStatusUpdated = function (groupChannel) {
            var typingMembers = groupChannel.getTypingMembers();
            if (typingMembers.length === 0) {
                $('.js-loading').each(function (index, item) {
                    $(item).hide();
                });
                return;
            }
            shouldUseInverseMode = false;
            for (var i in typingMembers) {
                var shouldDisplay = true;
                var $typingIndicatorSelector = $('.js-loading');
                $typingIndicatorSelector.each(function (index, item) {
                    if ($(item).attr('data-userId') == typingMembers[i].userId && !$(item).is(':hidden')) {
                        shouldDisplay = false;
                    }
                });

                if (shouldDisplay) {
                    var $message = $typingIndicatorSelector.last().clone();
                    $message.find('.user-avatar').first().attr('src', typingMembers[i].profileUrl);
                    $message.attr('data-userId', typingMembers[i].userId);
                    addMessageToChatColumn($message, groupChannel.url);
                    if (groupChannel.url == channelId && shouldDisplay) {
                        scrollChatToBottom();
                    }
                }
            }
        };
        ChannelHandler.onUserJoined = function(groupChannel, user) {
            window.location.reload(true);
        };
        sb.addChannelHandler(uuidv4(), ChannelHandler);
        var channelListQuery = sb.GroupChannel.createMyGroupChannelListQuery();
        channelListQuery.includeEmpty = true;
        channelListQuery.limit = 20; // pagination limit could be set up to 100

        if (channelListQuery.hasNext) {
            channelListQuery.next(function (channelList, error) {
                if (error) {
                    console.error(error);
                }
                channelsCount = channelList.length;
                for (var i in channelList) {
                    var groupChannel = channelList[i];
                    channels[groupChannel.url] = groupChannel;
                    var prevMessageListQuery = groupChannel.createPreviousMessageListQuery();
                    prevMessageListQuery.limit = messagesLimit;
                    prevMessageListQuery.reverse = true;
                    prevMessageListQuery.load(loadMessages);
                    channelQueries[groupChannel.url] = prevMessageListQuery;
                }
            });
        }
    }

    var channelsProcessed = 0;
    var optionMessageWithoutText = null;

    function loadMessages(messages, error) {
        if (error) {
            $('.messages-loader').hide();
            console.error(error);
            return;
        }
        if (!messages || messages.length <= 0) {
            $('.messages-loader').hide();
            return;
        }

        function compare(a, b) {
            if (a.createdAt < b.createdAt)
                return -1;
            if (a.createdAt > b.createdAt)
                return 1;
            return 0;
        }

        if (!sendBirdWasInitialized) {
            // sorting by date
            messages.sort(compare);
        }
        shouldUseInverseMode = sendBirdWasInitialized;

        $('.js-loading').each(function (index, item) {
            $(item).hide();
        });
        if (messages[0].customType === 'url_preview') {
            optionMessageWithoutText = messages[0];
            channelQueries[channelId].load(loadMessages);
            messages[0] = null;
        }
        for (var j in messages) {
            var index = parseInt(j);
            if (messages[index] === null) {
                continue;
            }
            parseMessage(messages[index], messages[index - 1], messages[index + 1]);
            lastDisplayedMessage = messages[index];
        }
        $('.messages-loader').hide();
        channelsProcessed++;
        if (sendBirdWasInitialized && $lastMessage) {
            $messagesContainer.animate({
                scrollTop: $lastMessage.offset().top
            }, 0);
        }
        if (channelsProcessed >= channelsCount && !sendBirdWasInitialized) {
            setTimeout(function () {
                scrollChatToBottom();
            }, 500);
            sendBirdWasInitialized = true;
        }
    }

    // var userNickname = 'split101';
    var chatColumn = $('.chat-column').find('.messages').each(function (index, item) {
        $('.js-loading').first().clone().show().appendTo($(item));
    });

    var renderedDates = [];

    function getReplies(messageObject) {
        try {
            var parsed = JSON.parse(messageObject.message);
            var replies = parsed.replies;
            var questionId = parsed.questionId;
        } catch (e) {
            try {
                var decoded = window.atob(messageObject.message); // trying to parse b64 from it
                replies = decoded.replies;
                questionId = decoded.questionId;
            } catch (e) {
                console.error('Error during parsing message with type url_preview, message text: ' + messageObject.message);
            }
        }
        return [replies, questionId];
    }

    function parseMessage(messageObject, prevMessageObject, nextMessageObject, shouldAddFile) {
        $('.select').first().hide();
        $('.js-chat-input').show();
        var date = new Date(messageObject.createdAt);
        var messageGroupDate = date.getDate() + ' ' + months[date.getMonth()];
        var channelUrl = messageObject.channelUrl;
        var index = (channelUrl + messageGroupDate).replace(/ /g, "_");
        if (renderedDates[index] === undefined || (renderedDates[index] > messageObject.createdAt)) {
            $('#' + index).hide();
            renderedDates[index] = messageObject.createdAt;
            var dateContainer = $('#js-date-container').clone();
            dateContainer.text(messageGroupDate);
            dateContainer.attr('id', index);
            addMessageToChatColumn(dateContainer, channelUrl);
        }

        switch (messageObject.customType) {
            case 'url_preview' :
                var res = getReplies(messageObject);
                var questionId = res[1];
                var replies = res[0];
                var message = /*prevMessageObject.message*/'';
                if (prevMessageObject) {
                    message = prevMessageObject.message;
                }
                renderMessage(messageObject, message, replies, questionId);
                break;
            case 'url_preview_cards':
                var cards = null;
                // XXX for some reason message could contain actual json which is not parasable because it has u' at the start
                if (messageObject.message[0] == '{') {
                    var m = '' + messageObject.message;
                    m = m.replace(/u'/g, '\'');
                    m = m.replace(/'/g, '"');
                    cards = JSON.parse(m);
                } else {
                    try {
                        cards = window.atob(messageObject.message); // trying to parse b64 from it
                    } catch (e) {
                        console.error('Cards data couldnt be parsed from message, message: ' + messageObject.message);
                    }
                }
                renderCards(cards, messageObject);
                break;
            case '':
                if (optionMessageWithoutText) {
                    var res = getReplies(optionMessageWithoutText);
                    renderMessage(optionMessageWithoutText, messageObject.message, res[0], res[1]);
                    optionMessageWithoutText = null;
                    break;
                }
                if (messageObject.messageType == 'file') {
                    if (shouldAddFile) {
                        try {
                            var fileData = JSON.parse(messageObject.data.replace(/'/g, '"'));
                            renderUploadedFile(fileData.file_path, fileData.thumb_path);
                            break;
                        } catch (e) {
                            renderImage(messageObject, messageObject.url);
                            break;
                        }
                    }
                    if (messageObject.name.slice(messageObject.name.indexOf('.') + 1) === 'pdf') {
                        var fileData = JSON.parse(messageObject.data.replace(/'/g, '"'));
                        renderImage(messageObject, fileData.file_path);
                    } else {
                        renderImage(messageObject, messageObject.url);
                    }
                    break;
                }
                if (isUserMessage(messageObject)) {
                    renderMessage(messageObject, messageObject.message);
                    break;
                }
                // to prevent duplicates (plain message and same with options)
                if (nextMessageObject && nextMessageObject.customType != 'url_preview' && !optionMessageWithoutText) {
                    renderMessage(messageObject, messageObject.message);
                    break;
                }
                if (!isUserMessage(messageObject) && (!nextMessageObject || nextMessageObject.customType == '')) {
                    renderMessage(messageObject, messageObject.message);
                }
                break;
            case 'url_preview_input_string':
            case 'url_preview_input_int':
            case 'url_preview_multiple_inputs':
                var parsed = JSON.parse(messageObject.message);
                renderMessage(messageObject, parsed.input, null, parsed.questionId);
                break;
            case 'url_preview_list':
                renderSelect(messageObject);
                break;
            default:
                console.error('unknown message type', messageObject.customType);
                break;
        }
        $('.js-loading').each(function (index, item) {
            $(item).hide();
        });
        var observer = lozad();
        observer.observe();
    }

    function renderSelect(messageObject) {
        $('.list-select').remove();
        $('.select').remove();
        var parsed = messageObject.message.replace(/'/g, '"');
        parsed = JSON.parse(parsed);
        var options = parsed.list;
        var select = $('<select></select>');
        var id = uuidv4();
        select.attr('id', id);
        select.attr('class', 'list-select');
        select.attr('data-questionId', parsed.questionId);
        for (var i in options) {
            select.append(new Option(options[i].text, options[i].input));
        }
        select.insertAfter($('.attach-container'));
        select.each(selectInit);
        $('.js-chat-input').hide();
        $('.select').first().show();
    }

    function renderImage(messageObject, filePath) {
        var imageUrl = messageObject.url;
        var sentAtAsString = getSentAtAsString(new Date(messageObject.createdAt));
        var $messageContainer = null;
        if (isUserMessage(messageObject)) {
            $messageContainer = $('.user-message').first();
            if (isConciergePage) {
                $messageContainer.addClass('user-message--concierge');
            }
        } else {
            $messageContainer = $('.responder-message-container').not('.user-message').first();
        }
        var $avatar = $messageContainer.find('.user-avatar').first();
        $avatar.attr('src', getProfileUrl(messageObject));
        var senderData = getNickname(messageObject) + ', ' + sentAtAsString;
        $messageContainer = $messageContainer.clone();
        var $messageTextField = $messageContainer.find('.js-message-text').first();
        $messageContainer.find('.js-sent-at').first().text(senderData);
        var image = $('<img/>').attr('data-src', imageUrl);
        image.attr('data-file-url', filePath);
        image.css('width', '100%');
        image.css('height', '100%');
        image.appendTo($messageTextField);
        image.addClass('text-image');
        image.addClass('lozad');
        $messageTextField.addClass('image-message');
        // console.log(filepa);
        addMessageToChatColumn($messageContainer, messageObject.channelUrl);
        if (sendBirdWasInitialized) {
            // scrollChatToBottom();
        }
    }

    function renderFile(messageObject, filePath, thumbPath) {
        var sentAtAsString = getSentAtAsString(new Date(messageObject.createdAt));
        var $messageContainer = null;
        if (isUserMessage(messageObject)) {
            $messageContainer = $('.user-message').first();
            if (isConciergePage) {
                $messageContainer.addClass('user-message--concierge');
            }
        } else {
            $messageContainer = $('.responder-message-container').not('.user-message').first();
        }
        var $avatar = $messageContainer.find('.user-avatar').first();
        $avatar.attr('src', getProfileUrl(messageObject));
        var senderData = getNickname(messageObject) + ', ' + sentAtAsString;
        $messageContainer = $messageContainer.clone();
        var $messageTextField = $messageContainer.find('.js-message-text').first();
        $messageContainer.find('.js-sent-at').first().text(senderData);
        var anchor = $('<a></a>');
        anchor.attr('href', filePath);
        anchor.attr('target', '_blank');
        anchor.attr('class', 'message__file-link');
        // var fileIcon = $('<i class="far fa-file message__file-icon"></i>');
        // fileIcon.prependTo(anchor);
        var preview = $('<img/>');
        preview.attr('data-src', thumbPath);
        preview.prependTo(anchor);
        preview.addClass('lozad');
        preview.css('width', '100%');
        anchor.appendTo($messageTextField);
        addMessageToChatColumn($messageContainer, messageObject.channelUrl);
        // $messageContainer.appendTo(chatColumn);
        if (sendBirdWasInitialized) {
            // scrollChatToBottom();
        }
    }

    function renderMessage(messageObject, messageText, replies, questionId) {
        var $messageContainer = null;
        var senderData = null;
        var sentAtAsString = getSentAtAsString(new Date(messageObject.createdAt));
        if (isUserMessage(messageObject)) {
            $messageContainer = $('.user-message').first();
            var $avatar = $messageContainer.find('.user-avatar').first();
            if (isConciergePage) {
                $avatar.remove();
            } else {
                $avatar.attr('src', getProfileUrl(messageObject));
            }
            senderData = getNickname(messageObject) + ', ' + sentAtAsString;
            if (isConciergePage) {
                $messageContainer.addClass('user-message--concierge');
            }
        } else {
            $messageContainer = $('.responder-message-container').not('.user-message').first();
            var $avatar = $messageContainer.find('.user-avatar').first();
            $avatar.attr('src', getProfileUrl(messageObject));
            senderData = getNickname(messageObject) + ', ' + sentAtAsString;
        }
        $messageContainer = $messageContainer.clone();
        var $messageTextField = $messageContainer.find('.js-message-text').first();
        if (!isUserMessage(messageObject)) {
            messageText = urlify(messageText);
        }
        $messageTextField.html(messageText);
        $messageContainer.find('.js-sent-at').first().text(senderData);
        if (replies) {
            for (var i in replies) {
                var $buttonSample = $messageContainer.find('.option-button').first();
                var $button = $buttonSample.clone();
                $button.text(replies[i].reply);
                $button.attr('data-questionId', questionId);
                $button.attr('data-userId', userId);
                $button.show();
                $button.insertAfter($messageTextField);
            }
        }
        if (messageHasInput(messageObject)) {
            var $input = $messageContainer.find('.js-message-input').first().clone();
            $input.attr('data-questionId', questionId);
            $input.show().insertAfter($messageTextField);
        }
        if (isAdminMessage(messageObject)) {
            $messageContainer.addClass('admin-message');
            $messageTextField.parent().addClass('text--admin-message');
            $messageTextField.prepend('<i class="fab fa-android admin-message__android-icon"></i>');
        }
        addMessageToChatColumn($messageContainer, messageObject.channelUrl);
        // $messageContainer.appendTo(chatColumn);
        if (sendBirdWasInitialized) {
            // scrollChatToBottom();
        }
    }

    var $messagesContainer = $('#' + channelId).first();

    function scrollChatToBottom() {
        var x = $('#' + channelId).first();
        var lastElement = x.find('.js-chat-message').last().get(0);
        var offset = lastElement ? lastElement.offsetTop : 100;
        x.animate({
            scrollTop: offset
        }, 250);
    }

    $(document).on('click', '.option-button', function () {
        if ($(this).hasClass('payment-button')) {
            // return;
        }
        scrollChatToBottom();
        var questionId = $(this).attr('data-questionId');
        var reply = $(this).text();
        var data = {
            userId: userId,
            msg: {
                replies: reply,
                questionId: questionId
            },
            channelId: channelId
        };

        if (!$(this).hasClass('payment-button')) {
            $('.js-loading').first().clone().show().appendTo(chatColumn);
        }

        $.post(apiPostMessageUrl, JSON.stringify(data))
            .always(function () {

            });
        // if (!timerStarted) {
        //     timerStarted = true;
        //     setInterval(initSendBird, 2000);
        // }
    });

    var offsetInPixels = 328;

    function renderCards(cardsObject, messageObject) {
        var $cardsContainer = $('.js-cards-container').first().clone();
        $cardsContainer.find('.user-avatar').first().attr('src', getProfileUrl(messageObject));
        var cardsData = cardsObject.cards;
        if (cardsData.length === 1) {
            $cardsContainer.find('.gallery-switcher').each(function (index, item) {
                $(item).hide();
            })
        }
        for (var i in cardsData) {
            var $galleryItem = $cardsContainer.find('.gallery-item').first().clone();
            var $gallery = $cardsContainer.find('.gallery').first();
            $galleryItem.find('img').first().attr('data-src', cardsData[i].url_image);
            $galleryItem.find('.js-message-text').first().text(cardsData[i].text);
            var $textContainer = $galleryItem.find('.js-text-container').first();
            for (var j in cardsData[i].buttons) {
                var $buttonSample = $galleryItem.find('.option-button').first().clone();
                $buttonSample.text(cardsData[i].buttons[j].text);
                if (cardsData[i].buttons[j].type && cardsData[i].buttons[j].type === 'payment') {
                    $buttonSample.addClass('payment-button');
                    $buttonSample.attr('data-amount', parseFloat(cardsData[i].buttons[j].data.amount));
                    $buttonSample.attr('data-description', cardsData[i].buttons[j].data.description);
                }
                $buttonSample.show();
                $buttonSample.appendTo($textContainer);
            }
            var index = parseInt(i);
            if (index !== 0) {
                $galleryItem.css('position', 'absolute');
                $galleryItem.css('left', (i * offsetInPixels) + 'px');
                $galleryItem.css('top', '8px');
                $galleryItem.removeClass('gallery-item--selected');
            } else {
                $galleryItem.addClass('gallery-item--selected');
            }
            $galleryItem.show();
            $galleryItem.appendTo($gallery);
        }
        $cardsContainer.show();
        var sentAtAsString = getSentAtAsString(new Date(messageObject.createdAt));
        var senderData = getNickname(messageObject) + ', ' + sentAtAsString;
        $cardsContainer.find('.js-sent-at').first().text(senderData);
        addMessageToChatColumn($cardsContainer, messageObject.channelUrl);
        // $cardsContainer.appendTo(chatColumn);
    }

    function getSentAtAsString(date) {
        var hours = date.getHours();
        if (hours < 10) {
            hours = '0' + hours;
        }
        var minutes = date.getMinutes();
        if (minutes < 10) {
            minutes = '0' + minutes;
        }
        return hours + ':' + minutes;
    }

    $(document).on('click', '.gallery-switcher--right', function () {
        var currentlyDisplayedCard = $(this).parent().find('.gallery-item--selected').first();
        // XXX -1 here because parent div contains sample element which is needed for initial rendering, bad hack, but still
        var elementIndex = currentlyDisplayedCard.index() - 2;
        var nextCard = currentlyDisplayedCard.next('.gallery-item').first();
        var offset = offsetInPixels * elementIndex;
        currentlyDisplayedCard.css('transform', 'translate(-' + offset + 'px, 0px)');
        currentlyDisplayedCard.nextAll().each(function (index, item) {
            var offset = offsetInPixels * elementIndex;
            $(item).css('transform', 'translate(-' + offset + 'px, 0px)');
        });

        currentlyDisplayedCard.removeClass('gallery-item--selected');
        nextCard.addClass('gallery-item--selected');
        hideButtonsIfNeeded($(this).parent());
    });

    $(document).on('click', '.gallery-switcher--left', function () {
        var currentlyDisplayedCard = $(this).parent().find('.gallery-item--selected').first();
        // // XXX -3 here because parent div contains sample element which is needed for initial rendering, bad hack, but still
        var prevCard = currentlyDisplayedCard.prev('.gallery-item');
        var elementIndex = prevCard.index() - 3;
        var offset = offsetInPixels * elementIndex;
        $('.gallery-item').each(function (index, item) {
            $(item).css('transform', 'translate(-' + offset + 'px, 0px)');
        });
        currentlyDisplayedCard.removeClass('gallery-item--selected');
        prevCard.addClass('gallery-item--selected');
        hideButtonsIfNeeded($(this).parent());
    });

    function hideButtonsIfNeeded(element) {
        var currentlyDisplayedCard = element.find('.gallery-item--selected').first();
        var rightSwitcher = element.find('.gallery-switcher--right').first();
        var leftSwitcher = element.find('.gallery-switcher--left').first();
        if (currentlyDisplayedCard.siblings('.gallery-item').length == currentlyDisplayedCard.index() - 2) {
            rightSwitcher.hide();
        } else {
            rightSwitcher.show();
        }
        if (currentlyDisplayedCard.index() == 3) {
            leftSwitcher.hide();
        } else {
            leftSwitcher.show();
        }
    }

    function isUserMessage(messageObject) {
        if (!messageObject.sender) {
            return false;
        }
        return messageObject.sender.userId == userId;
    }

    function hashFnv32a(str, asString, seed) {
        /*jshint bitwise:false */
        var i, l,
            hval = (seed === undefined) ? 0x811c9dc5 : seed;

        for (i = 0, l = str.length; i < l; i++) {
            hval ^= str.charCodeAt(i);
            hval += (hval << 1) + (hval << 4) + (hval << 7) + (hval << 8) + (hval << 24);
        }
        if (asString) {
            // Convert to 8 digit hex string
            return ("0000000" + (hval >>> 0).toString(16)).substr(-8);
        }
        return hval >>> 0;
    }

    $(document).on('keyup', '.js-message-input', function (event) {
        if (event.keyCode !== 13) {
            return;
        }
        var data = {
            userId: userId,
            msg: {
                replies: $(this).val(),
                questionId: $(this).attr('data-questionId'),
            },
            channelId: channelId
        };
        $('.js-loading').first().clone().show().appendTo(chatColumn);
        scrollChatToBottom();
        $.post(apiPostMessageUrl, JSON.stringify(data));
        // if (!timerStarted) {
        //     timerStarted = true;
        //     setInterval(initSendBird, 2000);
        // }
    });

    $(document).on('keyup', '.js-chat-input', function (event) {
        if (event.shiftKey && event.keyCode === 13) {
            return;
        }
        if (event.keyCode === 13) {
            $(this).val("");
            $(this).css('height', '40px');
        }
    });

    $(document).on('keyup', '.js-chat-input', debounce(function (event) {
        channels[channelId].endTyping();
    }, 1500));

    $(document).on('change keyup keydown paste cut', '.js-chat-input', function () {
        $(this).height(0).height(this.scrollHeight - 20);
    }).find('.js-chat-input').change();

    $(document).on('keydown', '.js-chat-input', function (event) {
        var inp = String.fromCharCode(event.keyCode);
        if (/[a-zA-Z0-9-_ ]/.test(inp)) { // if key is alphanum - start typing
            channels[channelId].startTyping();
        }
        if (event.shiftKey && event.keyCode === 13) {
            return;
        }
        if (event.keyCode !== 13) {
            return;
        }
        var userMessage = $(this).val();
        if (handleUserMessage(userMessage)) {
            $(this).css('height', '40px');
        }
    });

    function handleUserMessage(userMessage) {
        if (userMessage.length < 0) {
            return false;
        }
        var data = {
            userId: userId,
            msg: userMessage,
            channelId: channelId
        };

        channels[channelId].sendUserMessage(userMessage, null, '', function (message, error) {
            if (error) {
                console.error(error);
                return;
            }
            channels[channelId].endTyping();
            parseMessage(message);
            scrollChatToBottom();
        });
        $.post(apiPostMessageUrl, JSON.stringify(data));
        return true;
    }

    $(document).on('click', '.chat-column__attach', function (event) {
        event.preventDefault();
        $('.chat-column__file-input').first().click();
    });

    $(document).on('change', '.chat-column__file-input', function (event) {
        event.preventDefault();
        var userFile = $(this).prop('files')[0];
        var formData = getFormData();
        formData.append('file', userFile);

        $.ajax({
            url: '/upload-chat',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
                // renderUploadedFile(data);
                scrollChatToBottom();
            },
            error: function (error) {
                console.error(error);
            },
        });
    });

    function getFormData() {
        var formData = new FormData();
        formData.append('userId', userId);
        formData.append('channelId', channelId);
        return formData;
    }

    function renderUploadedFile(filepath, thumbpath) {
        var path = filepath;
        var filename = path.split('/').pop();
        var date = new Date();
        var dateAsString = date.toDateString() + date.toLocaleTimeString();
        renderDoc(channelId, filename, 'misterx', dateAsString, path, thumbpath, true);
    }

    $(document).on('click', '.text-image', function () {
        modal.find('img').first().attr('src', $(this).attr('src'));
        var fileUrl = modal.find('#open-file__url');
        fileUrl.attr('href', $(this).attr('data-file-url'));
        fileUrl.attr('target', '_blank');
        modal.show();
    });

    $(document).on('click', '.close-modal', function () {
        modal.hide();
    });

    function getProfileUrl(messageObject) {
        if (!messageObject.sender) {
            return '';
        }
        return messageObject.sender.profileUrl.replace('http://omne', 'https://www.omne').replace('http://botvest', 'https://www.botvest');
    }

    function getNickname(messageObject) {
        if (!messageObject.sender) {
            return 'Admin';
        }
        return messageObject.sender.nickname;
    }

    function messageHasInput(messageObject) {
        return messageObject.customType == 'url_preview_input_string'
            || messageObject.customType == 'url_preview_input_int'
            || messageObject.customType == 'url_preview_multiple_inputs';
    }

    $(document).on('click', '.js-chat-scroll', function (event) {
        event.preventDefault();
        scrollChatToBottom();
    });

    function isAdminMessage(messageObject) {
        return messageObject.messageType == 'admin';
    }

    $(document).bind('drop dragover', function (e) {
        e.preventDefault();
    });

    // $('#fileupload').bind('fileuploadprogress', function (e, data) {
    //     // Log the current bitrate for this upload:
    //     console.log(data.bitrate);
    // });

    var dropZone = jsChatColumn;
    $('#fileupload').fileupload({
        dropZone: dropZone,
        add: function (e, data) {
            for (var i in data.files) {
                var formData = getFormData();
                formData.append('file', data.files[i]);
                var $fileContainer = $('.uploaded-file').first().clone();
                $fileContainer.find('.uploaded-file__info h1').first().text(data.files[i].name);
                // var id = hashFnv32a(data.files[i].name.replace(/\s/g, "_"));
                // $fileContainer.attr('id', id);
                addMessageToChatColumn($fileContainer, channelId);
                scrollChatToBottom();
                $.ajax({
                    url: '/upload-chat',
                    type: 'POST',
                    data: formData,
                    // Tell jQuery not to process data or worry about content-type
                    // You *must* include these options!
                    cache: false,
                    contentType: false,
                    processData: false,

                    // Custom XMLHttpRequest
                    xhr: function () {
                        var myXhr = $.ajaxSettings.xhr();
                        // if (myXhr.upload) {
                        //     // For handling the progress of the upload
                        //     myXhr.upload.addEventListener('progress', function (e) {
                        //         if (e.lengthComputable) {
                        //             var percentage = parseFloat(e.loaded / e.total).toFixed(2) * 100;
                        //             if (percentage === 100) {
                        //                 setTimeout(function () {
                        //                     $fileContainer.find('circle').first().parent().fadeOut('fast', function () {
                        //                         $(this).closest('.uploaded-file').remove();
                        //                     });
                        //                 }, 1000)
                        //             }
                        //             setProgress(percentage, $fileContainer.find('circle').first()[0]);
                        //         }
                        //     }, false);
                        // }
                        return myXhr;
                    },
                    success: function (data) {
                        // renderUploadedFile(data);
                        // scrollChatToBottom();
                    },
                    error: function (error) {
                        console.error(error);
                    },
                });
            }
        },
    });

    // timeout = window.dropZoneTimeout;
    var dragOverlay = dropZone.find('.drag-and-drop').first();
    $(document).bind('dragover', function (e) {
        if ($(e.target).parents('#js-chat-column').length > 0) {
            dragOverlay.css('display', 'flex');
        } else {
            dragOverlay.hide();
        }
    });

    $(document).bind('drop', function () {
        dragOverlay.hide();
    });

    function setProgress(percent, element) {
        var circle = element;
        var radius = circle.r.baseVal.value;
        var circumference = radius * 2 * Math.PI;

        circle.style.strokeDasharray = circumference + ' ' + circumference;
        circle.style.strokeDashoffset = circumference;
        circle.style.strokeDashoffset = circumference - percent / 100 * circumference;
    }

    function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function addMessageToChatColumn(message, channelId) {
        var channelMessagesContainer = $('#' + channelId);
        if (channelMessagesContainer.length === 0) {
            if (shouldUseInverseMode) {
                hiddenContainers[channelId].prepend(message);
            } else {
                hiddenContainers[channelId].append(message);
            }
        } else {
            if (shouldUseInverseMode) {
                message.prependTo(channelMessagesContainer);
            } else {
                message.appendTo(channelMessagesContainer);
            }
        }
        message.show();
    }

    // Returns a function, that, as long as it continues to be invoked, will not
    // be triggered. The function will be called after it stops being called for
    // N milliseconds. If `immediate` is passed, trigger the function on the
    // leading edge, instead of the trailing.
    function debounce(func, wait, immediate) {
        var timeout;
        return function () {
            var context = this, args = arguments;
            var later = function () {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            var callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    };

    function mobileCheck() {
        var check = false;
        (function (a) {
            if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true;
        })(navigator.userAgent || navigator.vendor || window.opera);
        return check;
    }

    if (mobileCheck()) {
        var $downloadApps = $('.download-apps').first();
        $('.js-column').each(function (index, item) {
            $(item).hide();
        });
        $downloadApps.show();
    }

    $('#customSelect').each(selectInit);

    function selectInit() {
        var $this = $(this), numberOfOptions = $(this).children('option').length;

        $this.addClass('select-hidden');
        $this.wrap('<div class="select"></div>');
        $this.after('<div class="select-styled"></div>');

        var $styledSelect = $this.next('div.select-styled');
        $styledSelect.text($this.children('option').eq(0).text());

        var $list = $('<ul />', {
            'class': 'select-options'
        }).insertAfter($styledSelect);

        for (var i = 0; i < numberOfOptions; i++) {
            $('<li />', {
                text: $this.children('option').eq(i).text(),
                rel: $this.children('option').eq(i).val()
            }).appendTo($list);
        }

        var $listItems = $list.children('li');

        $styledSelect.click(function (e) {
            e.stopPropagation();
            $('div.select-styled.active').not(this).each(function () {
                $(this).removeClass('active').next('ul.select-options').hide();
            });
            $(this).toggleClass('active').next('ul.select-options').toggle();
        });

        $listItems.click(function (e) {
            $('.select').each(function (index, item) {
                $(item).hide();
            });
            e.stopPropagation();
            $styledSelect.text($(this).text()).removeClass('active');
            $this.val($(this).attr('rel'));
            $list.hide();
            $('.js-chat-input').show();
            var questionId = $this.attr('data-questionId');
            var selected = $this.val();
            var data = {
                userId: userId,
                msg: {
                    replies: selected,
                    questionId: questionId
                },
                channelId: channelId
            };
            $.post(apiPostMessageUrl, JSON.stringify(data))
                .always(function () {

                });
        });

        $(document).click(function () {
            $styledSelect.removeClass('active');
            $list.hide();
        });
    }

    var tokenTriggered = false;
    var handler = StripeCheckout.configure({
        key: 'pk_live_ms0wO9HQtHsHG2gWJq0wahLz', // FIXME get from some other place??
        // key: 'pk_test_pavnBBACknzbepGLWntkBJXy', // FIXME get from some other place??
        image: 'https://www.omne.ai/img/favicon-32x32.png',
        locale: 'auto',
        currency: 'eur',
        token: function (token) {
            // You can access the token ID with `token.id`.
            // Get the token ID to your server-side code for use.
            console.log(token);
            tokenTriggered = true;
        },
        closed: function() {
            if (tokenTriggered) {
                window.location.reload(true);
            }
        },
    });

    $(document).on('click', '.payment-button', function (event) {
        event.preventDefault();
        handler.open({
            name: 'La Villa del Lago',
            description: $(this).attr('data-description'),
            zipCode: true,
            currency: 'eur',
            amount: $(this).attr('data-amount')
        });
    });

    var searchBarOffset = 42; // FIXME remove hardcode, calculate that value
    $('#graphs-container').on('scroll', function () {
        var searchBar = $('#search-bar');
        var navBar = $('.nav-justified').first().parent();
        if ($(this).scrollTop() >= searchBarOffset) {
            searchBar.addClass('sticky');
            navBar.addClass('tabs__sticky');
        } else {
            searchBar.removeClass('sticky');
            navBar.removeClass('tabs__sticky');
        }
    });

    function changeTitle() {
        document.title = isOldTitle ? oldTitle : newTitle;
        $('#favicon').attr('href', isOldTitle ? oldFavicon : newFavicon);
        isOldTitle = !isOldTitle;
    }

    $(window).focus(function () {
        clearInterval(interval);
        interval = null;
        $("title").text(oldTitle);
        $('#favicon').attr('href', oldFavicon);
    });
    var observer = lozad();
    observer.observe();

    var channelUsers = [];
    $('#js-users-list-button').click(function (event) {
        event.preventDefault();
        var modal = $('#exampleModal');
        var modalBody = modal.find('.modal-body').first();
        modalBody.text('Loading...');
        var data = {
            channelId: channelId
        };
        $.post('/list-members', JSON.stringify(data), function (response) {
            channelUsers[channelId] = response.members;
            renderMembers();
        });
    });

    $('#js-invoice-button').click(function (event) {
        event.preventDefault();
    });

    $('#add-portfolio').click(function (event) {
        event.preventDefault();
        $('#new-portfolio-modal').modal();
    });

    function renderMembers() {
        var modal = $('#exampleModal');
        var modalBody = modal.find('.modal-body').first();
        modalBody.empty();
        for (var i in channelUsers[channelId]) {
            var userDiv = $('<div></div>').addClass('channel-user');
            var avatar = $('<img/>').addClass('channel-user__avatar').attr('src', channelUsers[channelId][i].profile_url.replace('http://omne', 'https://www.omne').replace('http://botvest', 'https://www.botvest'));
            var name = $('<span></span>').addClass('channel-user__name').text(channelUsers[channelId][i].nickname);
            var status = $('<span></span>').addClass('channel-user__status');
            var nameContainer = $('<div class="user-name__container"></div>');
            if (channelUsers[channelId][i].is_online || channelUsers[channelId][i].last_seen_at == 0) {
                status.addClass('online');
                status.text('Online');
            } else {
                var date = new Date(channelUsers[channelId][i].last_seen_at);
                var seentAt = date.getDate() + '/' + parseInt(parseInt(date.getMonth()) + 1) + '/' + date.getFullYear();
                status.text('last seen ' + seentAt);
            }
            avatar.appendTo(userDiv);
            name.appendTo(nameContainer);
            status.appendTo(nameContainer);
            nameContainer.appendTo(userDiv);
            userDiv.appendTo(modalBody);
        }
        $('<input type="text" class="form-control" id="new-user-id">').appendTo(modalBody);
        var $leaveButton = $('<button id="user-leave" class="btn btn-default user-operation" data-toggle="tooltip" data-placement="top" title="Leave"><img src="/static/img/leave.png"></button>');
        var $inviteButton = $('<button id="user-invite" class="btn btn-default user-operation" data-toggle="tooltip" data-placement="top" title="Invite"><img src="/static/img/invite.png"></button>');
        var $userOperationsContainer = $('<div class="user-operation__container"></div>');
        $inviteButton.tooltip();
        $leaveButton.tooltip();
        $inviteButton.appendTo($userOperationsContainer);
        $leaveButton.appendTo($userOperationsContainer);
        $userOperationsContainer.appendTo(modalBody);
        modal.modal();
    }

    $('#js-form-submit').click(function (event) {
        event.preventDefault();
        var $userMessageInput = $('.js-chat-input');
        var userMessage = $userMessageInput.val();
        if (handleUserMessage(userMessage)) {
            $userMessageInput.val('');
        }
    });

    $(document).on('click', '#user-leave', function (event) {
        event.preventDefault();
        var data = {
            channelId: channelId,
            userId: $('#new-user-id').val(),
        };
        $.post('/leave', JSON.stringify(data))
            .done(function () {
                window.location.reload(true);
            })
            .fail(function (error) {
                console.error(error);
            });
    });

    $(document).on('click', '#user-invite', function (event) {
        event.preventDefault();
        var data = {
            channelId: channelId,
            userId: $('#new-user-id').val(),
        };
        $.post('/invite', JSON.stringify(data))
            .done(function () {
                window.location.reload(true);
            })
            .fail(function (error) {
                console.error(error);
            });
    });

    $('#add-portfolio-submit').click(function (event) {
        event.preventDefault();
        var $portfolioNameInput = $('#new-portfolio-name');
        var data = {
            userId: userId,
            portfolio_name: $portfolioNameInput.val(),
        };
        $.post('/startportfolio', JSON.stringify(data))
            .done(function () {
                window.location.reload(true);
            })
            .fail(function (error) {
                console.error(error);
            });
        $portfolioNameInput.val('');
    });

    $(document).on('click', '.js-sync-button', function (event) {
        event.preventDefault();
        $(this).addClass('portfolio-syncing');
        var syncingChannelId = $(this).attr('data-channelId');
        $.post('/refresh-portfolio', JSON.stringify({ channelId: syncingChannelId }))
            .done(function () {
                window.location.href = window.location.href.split('?')[0] + '?channelId=' + syncingChannelId;
            })
            .fail(function (error) {
                console.error(error);
            });
    });

    $('a[data-toggle=tab]').on('shown.bs.tab', function (e) {
        window.dispatchEvent(new Event('resize'));
    });

    $(document).on('click', '.file-delete', function (e) {
        e.preventDefault();
        var filename = $(this).parent().find('.file-description__filename').first().text();
        var data = {
            filename: filename,
            channelId: channelId
        };
        var element = $(this).parent();

        $.post('deletedocs', JSON.stringify(data))
            .done(function () {
                element.fadeOut();
            })
            .fail(function () {
                console.error('error');
            });

    });

    // used from iframe
    function submitInvoice(json) {
        // console.log(json);
        var data = {
            "userId": userId,
            "channelId": channelId,
            "Invoice": json
        };
        $.post('/insert-inv-data', JSON.stringify(data)).done(function (response) {
            if (response.error == 'True') { // bue
                var errorMsg = response.msg;
                $('#invoice-modal').find('.modal-body').prepend($('<div class="alert alert-danger" role="alert">' + errorMsg + '</div>'));
            } else {
                $('#invoice-modal').modal('hide');
            }
        });
    }

    window.onload = function () {
        $('#loader-overlay').hide();
        $('#concierge-iframe').attr('src','/concierge-example');
        $('#invoice-generator').attr('src','/insert-trans');
    };

    $('#invoice-modal').on('hidden.bs.modal', function (e) {
        $('#invoice-modal').find('.modal-body').find('alert-danger').remove();
    });

    function urlify(text) {
        var urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, function(url) {
            return '<a target="_blank" href="' + url + '">' + url + '</a>';
        })
    }

    $(document).on('click', '.js-portfolio-image', function () {
        $($(this).siblings()[0]).click();
    });

    $avatar.on('click', function () {
        event.preventDefault();
        $('#avatar-file-input').first().click();
    });

    $(document).on('change', '#avatar-file-input', function (event) {
        event.preventDefault();
        var userFile = $(this).prop('files')[0];
        var formData = getFormData();
        formData.append('file', userFile);

        $.ajax({
            url: '/update-profile-pic',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
                window.location.reload(true);
            },
            error: function (error) {
                console.error(error);
            },
        });
    });

    $(document).on('change', '.js-portfolio-image-input', function (event) {
        event.preventDefault();
        var userFile = $(this).prop('files')[0];
        var formData = getFormData();
        formData.append('file', userFile);
        $.ajax({
            url: '/update-channel-pic',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
                window.location.reload(true);
            },
            error: function (error) {
                console.error(error);
            },
        });
    });

    $('#load-more-button').click(function (event) {
        event.preventDefault();
        var button = $(this);
        if (button.hasClass('disabled')) {
            return;
        }
        button.addClass('disabled');
        button.html('<i class="fa fa-spinner fa-spin"></i>');
        $.get('/get-additional-channels/' + userId, '', function (response) {
            renderPortfolios(response.portList);
            initSendBird();
            initGraphs(response.portList);
            for (var i in response.documents) {
                renderChannelFiles(response.documents[i]);
            }
            button.removeClass('disabled');
            button.html('Load more');
        });
    });
</script>

</body>
</html>
